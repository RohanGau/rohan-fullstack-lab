name: Docker Build & Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout Repository
        uses: actions/checkout@v3

      - name: 🔢 Set NODE_ENV based on Branch
        id: set-env
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
          if [ "$GITHUB_REF" = "refs/heads/main" ]; then
            echo "NODE_ENV=production" >> $GITHUB_ENV
          elif [ "$GITHUB_REF" = "refs/heads/develop" ]; then
            echo "NODE_ENV=stage" >> $GITHUB_ENV
          else
            echo "NODE_ENV=development" >> $GITHUB_ENV
          fi

      - name: 📝 Write .env for React Admin
        run: |
          if [ "$NODE_ENV" = "production" ]; then
            echo "REACT_APP_API_URL=https://rohan-backend-api.fly.dev" > ./apps/admin/.env
          else
            echo "REACT_APP_API_URL=https://rohan-backend-api-stage.fly.dev" > ./apps/admin/.env
          fi

      - name: 🔧 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🚧 Build Docker Image for React Admin
        run: |
          if [ "$NODE_ENV" = "production" ]; then
            IMAGE_TAG=react-admin:production
          elif [ "$NODE_ENV" = "stage" ]; then
            IMAGE_TAG=react-admin:stage
          else
            IMAGE_TAG=react-admin:latest
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "📦 Building image with tag: $IMAGE_TAG"
          docker build -t $IMAGE_TAG -f apps/admin/Dockerfile .

      - name: 🌐 Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 📦 Push Docker Image
        run: |
          echo "🚀 Pushing image: $IMAGE_TAG"
          docker tag $IMAGE_TAG ${{ secrets.DOCKER_USERNAME }}/$IMAGE_TAG
          docker push ${{ secrets.DOCKER_USERNAME }}/$IMAGE_TAG
